<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Панель працівника</title>
  <style>
    body { font-family: Arial, sans-serif; }
    #queue { margin-top: 20px; }
  </style>
</head>
<body>
<h1>Панель працівника</h1>

<!-- Створення талону -->
<h2>Створити талон</h2>
<form id="create-ticket-form">
  <label for="serviceId">Виберіть послугу:</label>
  <select id="serviceId" name="serviceId" required></select>

  <label for="workplaceId">Виберіть робоче місце:</label>
  <select id="workplaceId" name="workplaceId" required></select>

  <button type="submit">Створити талон</button>
</form>

<hr>

<!-- Оновлення талону -->
<h2>Оновити талон</h2>
<form id="update-ticket-form">
  <label for="queueId">ID талону:</label>
  <input type="number" id="queueId" name="queueId" required>

  <label for="newServiceId">Нова послуга:</label>
  <select id="newServiceId" name="newServiceId" required></select>

  <label for="newWorkplaceId">Нове робоче місце:</label>
  <select id="newWorkplaceId" name="newWorkplaceId" required></select>

  <button type="submit">Оновити талон</button>
</form>

<hr>

<!-- Видалення талону -->
<h2>Видалити талон</h2>
<input type="number" id="deleteQueueId" placeholder="ID талону">
<button onclick="deleteTicket()">Видалити талон</button>

<hr>

<!-- Виклик клієнта -->
<h2>Виклик клієнта</h2>
<button onclick="callNextClient()">Викликати наступного клієнта</button>

<hr>

<!-- Завершення сеансу -->
<h2>Завершити сеанс</h2>
<input type="number" id="sessionQueueId" placeholder="ID талону">
<button onclick="completeSession()">Завершити сеанс</button>

<script>
  // Завантаження списку послуг
  function loadServices() {
    fetch('/services/all-services')
            .then(response => response.json())
            .then(services => {
              const serviceSelect = document.getElementById('serviceId');
              const newServiceSelect = document.getElementById('newServiceId');
              services.forEach(service => {
                const option = document.createElement('option');
                option.value = service.id;
                option.text = service.serviceName;
                serviceSelect.appendChild(option);
                newServiceSelect.appendChild(option.cloneNode(true));
              });
            })
            .catch(error => console.error('Помилка при завантаженні послуг:', error));
  }

  // Завантаження робочих місць відповідно до вибраної послуги
  function loadWorkplaces(serviceId) {
    fetch(`/workplaces/by-service/${serviceId}`)
            .then(response => response.json())
            .then(workplaces => {
              const workplaceSelect = document.getElementById('workplaceId');
              workplaceSelect.innerHTML = ''; // Очищення попередніх опцій
              workplaces.forEach(workplace => {
                const option = document.createElement('option');
                option.value = workplace.id;
                option.text = `Вікно ${workplace.workplaceName}`;
                workplaceSelect.appendChild(option);
              });
            })
            .catch(error => console.error('Помилка при завантаженні робочих місць:', error));
  }

  document.getElementById('serviceId').addEventListener('change', function() {
    const serviceId = this.value;
    loadWorkplaces(serviceId);
  });

  // Створити талон
  document.getElementById('create-ticket-form').addEventListener('submit', function(event) {
    event.preventDefault();
    const serviceId = document.getElementById('serviceId').value;
    const workplaceId = document.getElementById('workplaceId').value;

    fetch('/queue/add-to-queue', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ clientId: clientId, serviceId: serviceId, workplaceId: workplaceId })
    })
            .then(response => response.json())
            .then(data => {
              alert(`Талон №${data.id} створено для послуги ${data.serviceEntity.serviceName} на робоче місце ${data.workplace.workplaceName}`);
              loadQueue();  // Оновлюємо чергу після створення талону
            })
            .catch(error => {
              console.error('Помилка:', error);
            });
  });

  // Оновлення талону
  document.getElementById('update-ticket-form').addEventListener('submit', function(event) {
    event.preventDefault();
    const queueId = document.getElementById('queueId').value;
    const newServiceId = document.getElementById('newServiceId').value;
    const newWorkplaceId = document.getElementById('newWorkplaceId').value;

    fetch(`/queues/update-ticket/${queueId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ newServiceId, newWorkplaceId })
    })
            .then(response => response.json())
            .then(data => {
              alert(`Талон оновлено: ${data.ticketNumber}`);
            })
            .catch(error => console.error('Помилка:', error));
  });

  // Видалення талону
  function deleteTicket() {
    const queueId = document.getElementById('deleteQueueId').value;
    fetch(`/queues/delete-ticket/${queueId}`, { method: 'DELETE' })
            .then(response => response.text())
            .then(data => {
              alert(data);
            })
            .catch(error => console.error('Помилка:', error));
  }

  // Виклик наступного клієнта
  function callNextClient() {
    const workplaceId = document.getElementById('workplaceId').value; // Отримуємо ID робочого місця
    fetch(`/queue/call-next-client/${workplaceId}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
              alert(`Клієнт з талоном №${data.id} викликано на робоче місце ${data.workplace.workplaceName}`);
              loadQueue();
            })
            .catch(error => {
              console.error('Помилка:', error);
            });
  }

  // Завершення сеансу
  function completeSession() {
    const queueId = document.getElementById('sessionQueueId').value;
    fetch(`/queue/complete-session/${queueId}`, { method: 'POST' })
            .then(response => response.text())
            .then(data => {
              alert(data);
              loadQueue();  // Оновлюємо чергу після завершення сеансу
            })
            .catch(error => {
              console.error('Помилка:', error);
            });
  }

  loadServices(); // Завантаження послуг при завантаженні сторінки
</script>
</body>
</html>
